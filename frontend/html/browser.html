<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="bathtown">
    <meta name="COPYRIGHT" content="Fotagrafia">
    <meta name="description" content="browser page">
    <!-- jQuery -->
    <script src="http://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <!-- jquery-confirm -->
    <link href="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.css" rel="stylesheet">
    <script src="https://cdn.bootcdn.net/ajax/libs/jquery-confirm/3.3.4/jquery-confirm.min.js"></script>
    <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.7.0/css/font-awesome.css">
    <link rel="stylesheet" type="text/css" href="../css/general.css">
    <link rel="stylesheet" type="text/css" href="../css/browser.css">
    <link rel="icon" href="../favicon.ico" type="image/x-icon">
    <base target="_self">
    <title>browser</title>
</head>

<body>

    <header>
        <ul>
            <li id="bar">
                <a><span class="fa fa-bars"></span></a>
                <ul id="barlist">
                    <li><a href="../html/home.html" class="home"><span><span class="fa fa-home"></span> Home</span></a>
                    </li>
                    <li><a href="../html/browser.html" class="browser imlooking"><span class="fa fa-cloud"></span>
                            Browser</a>
                    </li>
                    <li><a href="../html/search.html" class="search"><span class="fa fa-search"></span> Search</a></li>
                </ul>
            </li>

            <li id="logo"><a href="../html/bicycle.html"><span class="fa fa-bicycle"></span></a></li>

            <li class="account">
                <a target="_self" href="../html/login.html" class="myAccount"><span class="fa fa-child"></span>
                    Log in</a>
                <a class="my" target="_self" href="../html/login.html"><span class="fa fa-child"></span></a>
            </li>

            <li class="account">
                <a class="myAccount">My Account <span class="fa fa-angle-down"></span></a>
                <a class="my"><span class="fa fa-user"></span></a>
                <ul>
                    <li><a href="../html/upload.html"><span class="fa fa-cloud-upload"></span> Upload</a></li>
                    <li><a href="../html/myGallery.html"><span class="fa fa-photo"></span> My Gallery</a></li>
                    <li><a href="../html/myHearts.html"><span class="fa fa-heart"></span> My Hearts</a></li>
                    <li> <a id="logout"><span class="fa fa-sign-out"></span> Log out</a> </li>
                </ul>
            </li>
        </ul>
    </header>

    <main>

        <article id="browser">
            <header class="hinter"> </header>

            <aside class="browserAside">

                <form class="searchBox">
                    <input id="searchBoxText" type="text" placeholder="Search by Title..." />
                    <button id="searchBoxButton" type="button"><span class="fa fa-search"></span></button>
                </form>

                <h1>Hot Country</h1>
                <ul class="hotList hotCountry">
                    <li><a>Canada</a></li>
                    <li><a>United Kingdom</a></li>
                    <li><a>Italy</a></li>
                </ul>

                <h1>Hot City</h1>
                <ul class="hotList hotCity">
                    <li><a>London</a></li>
                    <li><a>Firenze</a></li>
                    <li><a>Calgary</a></li>
                </ul>

                <h1>Hot Content</h1>
                <ul class="hotList hotContent">
                    <li><a>Scenery</a></li>
                    <li><a>City</a></li>
                    <li><a>People</a></li>
                </ul>

            </aside>

            <section class="browserResult">
                <form class="filter" id="threeFilter">
                    <div>
                        <select class="byContent" id="content">
                            <option value="" style="display: none;">Filter by Content</option>
                            <option value="scenery">scenery</option>
                            <option value="city">city</option>
                            <option value="people">people</option>
                            <option value="animal">animal</option>
                            <option value="building">building</option>
                            <option value="wonder">wonder</option>
                            <option value="other">other</option>
                        </select>

                        <select class="byCountry" id="country"
                            onchange="countrysCity('#country option:selected','#city')">
                            <option value="" style="display: none;">Filter by Country</option>
                        </select>

                        <select class="byCity" id="city">
                            <option value="" style="display: none;">Filter by City</option>
                        </select>
                    </div>

                    <button type="button" value="Filter" id="linkageFilter">Filter</button>
                </form>

                <div class="mainPic">
                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                    <div class="picContain">
                        <img src="" onclick="openDetail(event)" />
                    </div>

                </div>

                <section class="pageNum">
                    <p> </p>
                </section>

            </section>
        </article>
    </main>

    <footer>
        <section>
            <copyright id="copyright">Copyright Â© 2020 Fotagrafia Inc. All rights reserved.</copyright>
            <div>
                <a href="../html/privacy.html">Privacy Policy</a>
                <span>|</span>
                <a href="../html/usage.html">Terms of Use</a>
                <span>|</span>
                <a href="../html/legal.html">Legal</a>
                <span>|</span>
                <a href="../html/siteMap.html">Site Map</a>
            </div>
        </section>
    </footer>

    <script src="../js/feature.js" type="text/javascript"></script>
    <script>
        $(function () {
            getCountries('#country');
            ImgFitDiv(".picContain img", 3, 4);
            getHotChoice();
            if (!getQueryVariable('page')) {
                getRadomImg().then(function (data) { browserShow(data) })
                $('.pageNum').hide()
            } else if (getQueryVariable('choice')) {
                if (getQueryVariable('choice') === 'title') $('#searchBoxText').val(getQueryVariable('text'));
                browserGetImg().then(function (data) { browserShow(data) })
            } else {
                browserGetFilterImg().then(function (data) { browserShow(data) })
                $(`#content option[value=${getQueryVariable('content')}]`).attr("selected", true);
                getCountries('#country').then(function () {
                    $(`#country option[value=${getQueryVariable('country')}]`).attr("selected", true);
                    countrysCity('#country option:selected', '#city').then(function () {
                        $(`#city option[value=${getQueryVariable('city')}]`).attr("selected", true);
                    })
                })
            }

            $('#searchBoxButton').click(function () {
                window.location.href = window.location.origin + window.location.pathname + `?page=1&choice=title&text=${$('#searchBoxText').val()}`
            })
            $('.hotCountry a').click(function () {
                window.location.href = window.location.origin + window.location.pathname + `?page=1&choice=country&text=${$(this).text()}`
            })
            $('.hotCity a').click(function () {
                window.location.href = window.location.origin + window.location.pathname + `?page=1&choice=city&text=${$(this).text()}`
            })
            $('.hotContent a').click(function () {
                window.location.href = window.location.origin + window.location.pathname + `?page=1&choice=content&text=${$(this).text()}`
            })
            $('#linkageFilter').click(function () {
                // scenery Canada Calgary
                let content = $('#content option:selected').val();
                let city = $('#city  option:selected').val();
                let country = $('#country option:selected').val();

                if (!content || !city || !country) {
                    myAlert('warning', 'Please select!');
                    return;
                } else {
                    window.location.href = window.location.origin + window.location.pathname + `?page=1&content=${content}&city=${city}&country=${country}`
                }
            })
        });

        function getHotChoice() {
            $.ajax({
                method: "GET",
                url: `${backendSrc}/imgChoice.php`,
            }).done((data) => {
                for (let index = 0; index < 3; index++) {
                    let content = data.content[index]
                    if (content) {
                        content = content.charAt(0).toUpperCase() + content.slice(1)
                        $('.hotContent li a').eq(index).text(content)
                    }
                    $('.hotCity li a').eq(index).text(data.city[index])
                    $('.hotCountry li a').eq(index).text(data.country[index])
                }
            }).fail((err) => {
                if (err.status === 0) { myAlert('error', 'Connection refused!'); return; }
                myAlert('error', JSON.parse(err.responseText).message);
            });
        }

        function browserGetFilterImg() {
            const content = getQueryVariable('content');
            const city = getQueryVariable('city');
            const country = getQueryVariable('country');
            const page = getQueryVariable('page');

            return $.ajax({
                method: "GET",
                url: `${backendSrc}/pageBrowser.php`,
                data: { content: content, city: city, country: country, page: page }
            }).done((data) => {
                return data
            }).fail((err) => {
                if (err.status === 0) { myAlert('error', 'Connection refused!'); return; }
                myAlert('error', JSON.parse(err.responseText).message);
            });
        }

        function getRadomImg() {
            return $.ajax({
                method: "GET",
                url: `${backendSrc}/imgRandom.php`,
                data: { num: 8 }
            }).done((data) => {
                return data;
            }).fail((err) => {
                if (err.status === 0) { myAlert('error', 'Connection refused!'); return; }
                myAlert('error', JSON.parse(err.responseText).message);
            });
        }

        function browserGetImg() {
            const choice = getQueryVariable('choice')
            const text = getQueryVariable('text')
            const page = getQueryVariable('page')

            return searchImg(choice, text, page)
                .then(function (data) {
                    return data;
                }).catch((err) => {
                    console.log(err);

                    if (err.status === 0) { myAlert('error', 'Connection refused!'); return; }
                    myAlert('error', JSON.parse(err.responseText).message);
                });
        }

        function browserShow(data) {
            if (data.pageNum === 0) {
                myAlert('success', 'No data yet ðŸ¤—')
                $('.pageNum').hide()
                return
            }

            for (let index = 0; index < data.imgs.length; index++) {
                $('img').eq(index).attr({
                    'src': `${backendImgSrc}/${data.imgs[index].src}`,
                    'data-id': data.imgs[index].id,
                });
            }

            $('.pageNum p').empty();
            $('.pageNum p').append('<span><<</span>')
            $('.pageNum p').append('<span id="before"><</span>')
            $('.pageNum p').append('<span>></span>')
            $('.pageNum p').append('<span>>></span>')

            // show pageNum
            showPageNum(data.pageNum)
            pageNumClick(data.pageNum)

            $('img').each(function () {
                if ($(this).attr('src') === '') $(this).parents('.picContain').hide()
                else $(this).parents('.picContain').show()
            })
        }

        // swipe right to show aside, swipe left to show filter
        function browserAsideAppear() {
            const browserAside = document.getElementsByClassName("browserAside")[0];
            const mainPic = document.getElementsByClassName("mainPic")[0];
            const browserResult = document.getElementsByClassName("browserResult")[0];
            const pageNum = document.getElementsByClassName("pageNum")[0];
            const threeFilter = document.getElementById("threeFilter");

            mainPic.addEventListener("swipeRight", function () {
                browserAside.style.display = "flex";
                browserResult.style.display = "none";
                pageNum.style.display = "none";
            });

            mainPic.addEventListener("swipeLeft", function () {
                threeFilter.style.transform = "translateX(0)";
            });

            threeFilter.addEventListener("swipeRight", function () {
                threeFilter.style.transform = "translateX(1000px)";
            });

            browserAside.addEventListener("swipeLeft", function () {
                browserAside.style.display = "none";
                browserResult.style.display = "flex";
                pageNum.style.display = "initial";
            });
        }
        // condition
        if (document.getElementsByClassName("browserAside")[0])
            browserAsideAppear();

    </script>

</body>

</html>
